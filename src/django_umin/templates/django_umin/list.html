<!-- templates/django_umin/list.html -->
{% extends "django_umin/base.html" %}
{% load django_umin_tags %}

{% block title %}{{ model_name_plural|title }}{% endblock %}

{% block content %}
<div x-data="{ showFilters: false }">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
            <div>
                <h2 class="text-3xl font-bold text-gray-900">{{ model_name_plural|title }}</h2>
                <p class="mt-1 text-sm text-gray-500">Manage your {{ model_name_plural }}</p>
            </div>
            <div class="mt-4 sm:mt-0">
                {% if has_add_permission %}
                <a href="{% crud_url url_namespace 'create' %}"
                   class="inline-flex items-center px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                    <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                    </svg>
                    Add {{ model_name|title }}
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    {% if crud_view.search_fields or crud_view.list_filter %}
    <!-- Search and Filters -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
        <div class="p-4">
            <form hx-get="{% crud_url url_namespace 'list' %}"
                  hx-target="#results-table"
                  {% if crud_view.search_fields %}hx-trigger="submit, input delay:500ms from:find input[name='q']"{% endif %}
                  hx-indicator="#search-indicator"
                  class="space-y-4">

                <!-- Search Bar -->
                {% if crud_view.search_fields %}
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </div>
                    <input type="text"
                           name="q"
                           value="{{ search_query }}"
                           placeholder="Search {{ model_name_plural }}..."
                           hx-on="htmx:afterRequest: target.classList.add('search-active')"
                           hx-on="htmx:afterSettle: target.classList.remove('search-active')"
                           class="block w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    <div id="search-indicator" class="absolute inset-y-0 right-0 pr-3 flex items-center">
                        <svg class="htmx-indicator animate-spin h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                </div>
                {% endif %}

                <!-- Filters -->
                {% if crud_view.list_filter %}
                <div x-show="showFilters" x-cloak class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    {% for filter_field in crud_view.list_filter %}
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            {{ filter_field|title }}
                        </label>
                        <select name="{{ filter_field }}"
                                class="block w-full py-2 px-3 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <option value="">All</option>
                            <!-- Add filter options dynamically -->
                        </select>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% if crud_view.list_filter %}
                <div class="flex justify-end">
                    <button type="button"
                            @click="showFilters = !showFilters"
                            class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                        </svg>
                        <span x-text="showFilters ? 'Hide Filters' : 'Show Filters'"></span>
                    </button>
                </div>
                {% endif %}
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Search Status -->
    {% if search_query %}
    <div class="mb-4 flex items-center justify-between">
        <div class="text-sm text-gray-600">
            <span class="font-medium">{{ object_list|length }}</span>
            result{{ object_list|length|pluralize }} found for
            <span class="font-medium text-indigo-600">"{{ search_query }}"</span>
        </div>
        <a href="{% crud_url url_namespace 'list' %}"
           class="text-sm text-indigo-600 hover:text-indigo-800 transition-colors">
            Clear search
        </a>
    </div>
    {% endif %}

    <!-- Results Table -->
    <div id="results-table" class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden htmx-target">
        {% include "django_umin/list_content.html" %}
    </div>


</div>

<script>
// Handle HTMX message display
document.addEventListener('DOMContentLoaded', function() {
    // Listen for HTMX triggers
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id === 'results-table') {
            // Check if there are HTMX messages in the swapped content
            const htmxMessages = evt.detail.target.querySelector('#htmx-messages');
            if (htmxMessages) {
                // Move messages to the main messages container
                const mainMessages = document.getElementById('messages');
                if (mainMessages) {
                    // Clear existing messages first
                    mainMessages.innerHTML = htmxMessages.innerHTML;
                    // Remove HTMX messages from the swapped content
                    htmxMessages.remove();
                }
            }

            // Add highlight animation to table rows
            const rows = evt.detail.target.querySelectorAll('tbody tr');
            rows.forEach((row, index) => {
                setTimeout(() => {
                    row.classList.add('htmx-updated-row');
                    setTimeout(() => {
                        row.classList.remove('htmx-updated-row');
                    }, 1500);
                }, index * 50);
            });
        }
    });

    // Clear search input highlight when search is cleared
    document.body.addEventListener('htmx:afterRequest', function(evt) {
        if (evt.detail.target.id === 'results-table') {
            const searchInput = document.querySelector('input[name="q"]');
            if (searchInput) {
                searchInput.classList.remove('search-active');
            }
        }
    });
});
</script>
{% endblock %}
